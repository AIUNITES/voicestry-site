<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sight Reading ‚Äî Learn to Read Music | VoiceStry</title>
  <meta name="description" content="Interactive sight reading trainer. Learn to identify notes on the treble and bass clef, practice reading music by sight, and build speed.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé§</text></svg>">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-purple: #9d4edd;
      --accent-cyan: #00d4ff;
      --accent-gold: #ffd700;
      --accent-green: #4ade80;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
    }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.7; }

    /* Webring */
    .aiunites-bar{background:linear-gradient(90deg,#0a0a0f,#1a1a2e);border-bottom:1px solid rgba(99,102,241,.3);padding:8px 0;font-size:12px}
    .aiunites-bar-content{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;align-items:center;gap:12px;overflow-x:auto;scrollbar-width:none}
    .aiunites-bar-content::-webkit-scrollbar{display:none}
    .aiunites-bar a{color:rgba(255,255,255,.7);text-decoration:none;white-space:nowrap;transition:color .2s}
    .aiunites-bar a:hover{color:#fff}
    .aiunites-bar-brand{color:#6366f1!important;font-weight:600}
    .aiunites-bar-divider{color:rgba(255,255,255,.2)}

    /* Nav */
    .nav { background: var(--bg-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
    .nav-logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .nav-links { display: flex; gap: 25px; flex-wrap: wrap; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
    .nav-links a:hover, .nav-links a.active { color: var(--accent-cyan); }

    /* Hero */
    .hero { padding: 50px 20px 30px; text-align: center; background: radial-gradient(ellipse at 50% 30%, rgba(255, 215, 0, 0.1) 0%, transparent 60%), var(--bg-dark); }
    .hero h1 { font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 12px; background: linear-gradient(135deg, var(--accent-gold), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero-sub { font-size: 1.05rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }

    .main { max-width: 850px; margin: 0 auto; padding: 30px 20px 80px; }

    /* Mode Tabs */
    .mode-tabs { display: flex; gap: 0; margin-bottom: 30px; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .mode-tab {
      flex: 1; padding: 14px; text-align: center; cursor: pointer;
      background: var(--bg-card); color: var(--text-secondary);
      font-weight: 700; font-size: 0.95rem; border: none; transition: all 0.2s; font-family: inherit;
    }
    .mode-tab:hover { background: rgba(255,255,255,0.04); }
    .mode-tab.active { background: var(--accent-gold); color: #000; }

    .panel { display: none; }
    .panel.active { display: block; }

    /* Staff Canvas */
    .staff-wrap {
      background: var(--bg-card); border-radius: 20px; padding: 30px 20px;
      border: 1px solid rgba(255,255,255,0.06); margin-bottom: 25px; text-align: center;
    }
    canvas.staff { display: block; margin: 0 auto; background: transparent; }

    /* Answer Buttons */
    .answer-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
    .note-btn {
      width: 60px; height: 60px; border-radius: 14px;
      background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1);
      color: var(--text-primary); font-size: 1.3rem; font-weight: 900;
      font-family: 'Courier New', monospace; cursor: pointer; transition: all 0.15s;
    }
    .note-btn:hover { border-color: var(--accent-purple); background: rgba(157, 78, 221, 0.1); transform: translateY(-2px); }
    .note-btn.correct { border-color: var(--accent-green); background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
    .note-btn.wrong { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }
    .note-btn.disabled { pointer-events: none; opacity: 0.5; }
    .note-btn.sharp { font-size: 1rem; width: 65px; }

    /* Score */
    .score-bar { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; }
    .score-item { text-align: center; }
    .score-num { font-size: 2rem; font-weight: 900; font-family: 'Courier New', monospace; }
    .score-label { font-size: 0.8rem; color: var(--text-secondary); }

    .result-msg {
      text-align: center; padding: 15px; border-radius: 12px; margin: 15px 0;
      font-size: 1rem; font-weight: 700; display: none;
    }
    .result-msg.show { display: block; }
    .result-msg.pass { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); color: var(--accent-green); }
    .result-msg.fail { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--accent-red); }

    .next-btn {
      display: block; margin: 15px auto 0; padding: 12px 28px;
      background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
      border: none; color: #000; border-radius: 12px; font-weight: 800;
      cursor: pointer; font-family: inherit; font-size: 0.95rem; transition: all 0.2s;
    }
    .next-btn:hover { transform: translateY(-2px); }

    .hear-btn {
      display: inline-block; margin: 10px auto; padding: 10px 24px;
      background: rgba(0, 212, 255, 0.12); border: 1px solid rgba(0, 212, 255, 0.3);
      color: var(--accent-cyan); border-radius: 10px; cursor: pointer;
      font-weight: 700; font-family: inherit; font-size: 0.9rem; transition: all 0.2s;
    }
    .hear-btn:hover { background: rgba(0, 212, 255, 0.25); }

    /* Settings */
    .settings-row {
      display: flex; align-items: center; gap: 15px; padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .settings-row label { flex: 1; color: var(--text-secondary); font-size: 0.9rem; }
    .settings-row select {
      background: var(--bg-card); color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; font-family: inherit;
    }

    /* Lesson cards */
    .lesson-card {
      background: var(--bg-card); border-radius: 16px; padding: 25px;
      border: 1px solid rgba(255,255,255,0.06); margin-bottom: 20px;
    }
    .lesson-card h3 { color: var(--accent-gold); margin-bottom: 10px; }
    .lesson-card p { color: var(--text-secondary); font-size: 0.95rem; }
    .mnemonic {
      font-family: 'Courier New', monospace; font-size: 1.3rem;
      color: var(--accent-cyan); margin: 15px 0; letter-spacing: 2px;
    }
    .mnemonic span { color: var(--accent-gold); font-weight: 900; font-size: 1.5rem; }

    /* Speed display */
    .speed-display {
      text-align: center; padding: 15px;
      background: rgba(157, 78, 221, 0.08); border-radius: 12px;
      border: 1px solid rgba(157, 78, 221, 0.15); margin: 15px 0;
    }
    .speed-val { font-size: 2rem; font-weight: 900; color: var(--accent-purple); font-family: 'Courier New', monospace; }
    .speed-label { font-size: 0.8rem; color: var(--text-secondary); }

    /* Footer */
    .footer { background: var(--bg-card); padding: 40px 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
    .footer p { color: var(--text-secondary); font-size: 0.9rem; }
    .footer a { color: var(--accent-purple); text-decoration: none; }

    @media (max-width: 768px) {
      .nav { flex-direction: column; gap: 12px; }
      .nav-links { flex-wrap: wrap; justify-content: center; gap: 12px; }
      .mode-tabs { flex-direction: column; }
      .note-btn { width: 50px; height: 50px; font-size: 1.1rem; }
      .note-btn.sharp { width: 55px; }
    }
  </style>
</head>
<body>

  <!-- Webring -->
  <div class="aiunites-bar"><div class="aiunites-bar-content"><a href="https://aiunites.github.io/aiunites-site/" class="aiunites-bar-brand">‚óÜ AIUNITES</a><span class="aiunites-bar-divider">|</span><a href="https://aiunites.github.io/aizines-app/">AIZines</a><a href="https://aiunites.github.io/aibyjob-demo/">AIByJob</a><a href="https://aiunites.github.io/redomy-demo/">Redomy</a><a href="https://aiunites.github.io/videobate-site/">VideoBate</a><a href="https://aiunites.github.io/voicestry-site/" style="color:var(--accent-green) !important;font-weight:600;">üé§ VoiceStry</a><a href="https://aiunites.github.io/bodspas-site/">BodSpas</a><a href="https://aiunites.github.io/furnishthings-site/">FurnishThings</a><a href="https://aiunites.github.io/bizstry-site/">BizStry</a><a href="https://aiunites.github.io/aiyhwh-site/">AI YHWH</a><a href="https://aiunites.github.io/cloudsion-site/">Cloudsion</a><a href="https://aiunites.github.io/gameatica-site/">Gameatica</a><a href="https://aiunites.github.io/uptownit-site/">UptownIT</a><a href="https://aiunites.github.io/inthisworld-site/">InThisWorld</a><a href="https://aiunites.github.io/erpise-site/">ERPise</a><a href="https://aiunites.github.io/erpize-site/">ERPize</a><a href="https://aiunites.github.io/cosmostheopera-site/">üåå COSMOS</a></div></div>

  <nav class="nav">
    <a href="index.html" class="nav-logo">üé§ VoiceStry</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="vrn-method.html">VRN Method</a>
      <a href="learn.html">Learn VRN</a>
      <a href="5-gears.html">5 Gears</a>
      <a href="vocal-gym.html">Vocal Gym</a>
      <a href="pitch-trainer.html">Pitch Trainer</a>
      <a href="sight-reading.html" class="active">Sight Reading</a>
      <a href="press.html">Press</a>
    </div>
  </nav>

  <section class="hero">
    <a href="vrn-method.html" style="display:inline-block;margin-bottom:18px;color:var(--accent-cyan);text-decoration:none;font-size:0.95rem;opacity:0.8;transition:opacity .2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">‚Üê Back to VRN Method</a>
    <h1>üëÅ Sight Reading</h1>
    <p class="hero-sub">Learn to read music by sight. Start with the basics ‚Äî lines and spaces ‚Äî then build speed identifying notes on the treble and bass clef.</p>
  </section>

  <main class="main">

    <div class="mode-tabs">
      <button class="mode-tab active" onclick="switchMode('learn')">üìñ Learn</button>
      <button class="mode-tab" onclick="switchMode('identify')">üéØ Identify Notes</button>
      <button class="mode-tab" onclick="switchMode('speed')">‚ö° Speed Drill</button>
    </div>

    <!-- LEARN MODE -->
    <div class="panel active" id="panel-learn">
      <div class="lesson-card">
        <h3>The Staff</h3>
        <p>Music is written on a <strong>staff</strong> ‚Äî five horizontal lines with four spaces between them. Each line and space represents a different note. Notes higher on the staff are higher in pitch.</p>
      </div>

      <div class="lesson-card">
        <h3>üéº Treble Clef (G Clef)</h3>
        <p>The treble clef is used for higher voices (soprano, mezzo, tenor) and most instruments. The clef symbol curls around the second line, which is <strong>G</strong>.</p>
        <p style="margin-top: 10px;"><strong>Lines</strong> (bottom to top):</p>
        <div class="mnemonic"><span>E</span>very <span>G</span>ood <span>B</span>oy <span>D</span>oes <span>F</span>ine</div>
        <p><strong>Spaces</strong> (bottom to top) spell:</p>
        <div class="mnemonic"><span>F</span> ‚Äî <span>A</span> ‚Äî <span>C</span> ‚Äî <span>E</span></div>
        <div style="text-align: center; margin-top: 15px;">
          <canvas id="learnTreble" width="500" height="160" style="max-width:100%;"></canvas>
        </div>
      </div>

      <div class="lesson-card">
        <h3>üéº Bass Clef (F Clef)</h3>
        <p>The bass clef is used for lower voices (baritone, bass) and left-hand piano. The two dots sit on either side of the fourth line, which is <strong>F</strong>.</p>
        <p style="margin-top: 10px;"><strong>Lines</strong> (bottom to top):</p>
        <div class="mnemonic"><span>G</span>ood <span>B</span>oys <span>D</span>o <span>F</span>ine <span>A</span>lways</div>
        <p><strong>Spaces</strong> (bottom to top):</p>
        <div class="mnemonic"><span>A</span>ll <span>C</span>ows <span>E</span>at <span>G</span>rass</div>
        <div style="text-align: center; margin-top: 15px;">
          <canvas id="learnBass" width="500" height="160" style="max-width:100%;"></canvas>
        </div>
      </div>

      <div class="lesson-card">
        <h3>Ledger Lines</h3>
        <p>Notes above or below the staff are written on short extra lines called <strong>ledger lines</strong>. Middle C (C4) sits on a ledger line ‚Äî one line below the treble staff or one line above the bass staff.</p>
      </div>

      <div class="lesson-card">
        <h3>üéµ Sharps and Flats</h3>
        <p>A <strong>sharp (‚ôØ)</strong> raises a note by one half-step. A <strong>flat (‚ô≠)</strong> lowers it by one half-step. These symbols appear just to the left of the note head on the staff.</p>
      </div>

      <p style="text-align: center; margin-top: 20px;">
        <button class="next-btn" onclick="switchMode('identify')">Ready to practice? Start Identifying Notes ‚Üí</button>
      </p>
    </div>

    <!-- IDENTIFY MODE -->
    <div class="panel" id="panel-identify">
      <div class="score-bar">
        <div class="score-item"><div class="score-num" style="color: var(--accent-green);" id="idCorrect">0</div><div class="score-label">Correct</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--accent-cyan);" id="idStreak">0</div><div class="score-label">Streak</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--text-secondary);" id="idTotal">0</div><div class="score-label">Attempts</div></div>
      </div>

      <div class="staff-wrap">
        <canvas class="staff" id="idStaff" width="400" height="200" style="max-width:100%;"></canvas>
        <button class="hear-btn" onclick="hearCurrentNote()">üîä Hear this note</button>
      </div>

      <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">What note is this?</p>
      <div class="answer-row" id="idAnswers"></div>
      <div class="result-msg" id="idResult"></div>
      <div style="text-align: center;">
        <button class="next-btn" id="idNextBtn" onclick="newIdQuestion()" style="display:none;">Next Note ‚Üí</button>
      </div>

      <div style="margin-top: 25px;">
        <div class="settings-row">
          <label>Clef:</label>
          <select id="idClef" onchange="newIdQuestion()">
            <option value="treble" selected>Treble Clef</option>
            <option value="bass">Bass Clef</option>
            <option value="both">Both Clefs</option>
          </select>
        </div>
        <div class="settings-row">
          <label>Include sharps/flats:</label>
          <select id="idAccidentals" onchange="newIdQuestion()">
            <option value="no" selected>Natural notes only</option>
            <option value="yes">Include sharps/flats</option>
          </select>
        </div>
      </div>
    </div>

    <!-- SPEED DRILL MODE -->
    <div class="panel" id="panel-speed">
      <div class="speed-display">
        <div class="speed-val" id="speedVal">‚Äî</div>
        <div class="speed-label">notes per minute</div>
      </div>

      <div class="score-bar">
        <div class="score-item"><div class="score-num" style="color: var(--accent-green);" id="spCorrect">0</div><div class="score-label">Correct</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--accent-red);" id="spWrong">0</div><div class="score-label">Wrong</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--accent-orange);" id="spTimer">30</div><div class="score-label">Seconds</div></div>
      </div>

      <div class="staff-wrap">
        <canvas class="staff" id="spStaff" width="400" height="200" style="max-width:100%;"></canvas>
      </div>

      <div class="answer-row" id="spAnswers"></div>

      <div style="text-align:center;">
        <button class="next-btn" id="spStartBtn" onclick="startSpeedDrill()">‚ö° Start 30-Second Drill</button>
      </div>

      <div class="result-msg" id="spFinalResult"></div>

      <div style="margin-top: 20px;">
        <div class="settings-row">
          <label>Clef:</label>
          <select id="spClef"><option value="treble" selected>Treble</option><option value="bass">Bass</option><option value="both">Both</option></select>
        </div>
        <div class="settings-row">
          <label>Duration:</label>
          <select id="spDuration"><option value="15">15 seconds</option><option value="30" selected>30 seconds</option><option value="60">60 seconds</option></select>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer">
    <p>
      ¬© 2002-2026 VoiceStry. All Rights Reserved. DMCA Protected.<br>
      Home of the <a href="vrn-method.html">VRN Method</a> ‚Äî Vocal Resonance Notation<br><br>
      <a href="index.html">Home</a> |
      <a href="vrn-method.html">VRN Method</a> |
      <a href="learn.html">Learn</a> |
      <a href="5-gears.html">5 Gears</a> |
      <a href="vocal-gym.html">Vocal Gym</a> |
      <a href="pitch-trainer.html">Pitch</a> |
      <a href="sight-reading.html">Sight Reading</a> |
      <a href="press.html">Press</a><br><br>
      Part of the <a href="https://aiunites.github.io/aiunites-site/">AIUNITES</a> network |
      Created by <a href="https://aiunites.github.io/cosmostheopera-site/">COSMOS the OPERA</a>
    </p>
  </footer>

  <script>
    var GOLD = '#ffd700';

    // Note pools
    function getTrebleNotes(acc) {
      var notes = [
        { name: 'C4', display: 'C', midi: 60, staffPos: -2, ledger: 1 },
        { name: 'D4', display: 'D', midi: 62, staffPos: -1 },
        { name: 'E4', display: 'E', midi: 64, staffPos: 0 },
        { name: 'F4', display: 'F', midi: 65, staffPos: 1 },
        { name: 'G4', display: 'G', midi: 67, staffPos: 2 },
        { name: 'A4', display: 'A', midi: 69, staffPos: 3 },
        { name: 'B4', display: 'B', midi: 71, staffPos: 4 },
        { name: 'C5', display: 'C', midi: 72, staffPos: 5 },
        { name: 'D5', display: 'D', midi: 74, staffPos: 6 },
        { name: 'E5', display: 'E', midi: 76, staffPos: 7 },
        { name: 'F5', display: 'F', midi: 77, staffPos: 8 },
        { name: 'G5', display: 'G', midi: 79, staffPos: 9 },
        { name: 'A5', display: 'A', midi: 81, staffPos: 10, ledger: 1 }
      ];
      if (acc) {
        notes.push(
          { name: 'F#4', display: 'F#', midi: 66, staffPos: 1, accidental: '#' },
          { name: 'C#5', display: 'C#', midi: 73, staffPos: 5, accidental: '#' },
          { name: 'Bb4', display: 'B‚ô≠', midi: 70, staffPos: 4, accidental: 'b' },
          { name: 'Eb5', display: 'E‚ô≠', midi: 75, staffPos: 7, accidental: 'b' }
        );
      }
      return notes;
    }

    function getBassNotes(acc) {
      var notes = [
        { name: 'E2', display: 'E', midi: 40, staffPos: -2, ledger: 1 },
        { name: 'F2', display: 'F', midi: 41, staffPos: -1 },
        { name: 'G2', display: 'G', midi: 43, staffPos: 0 },
        { name: 'A2', display: 'A', midi: 45, staffPos: 1 },
        { name: 'B2', display: 'B', midi: 47, staffPos: 2 },
        { name: 'C3', display: 'C', midi: 48, staffPos: 3 },
        { name: 'D3', display: 'D', midi: 50, staffPos: 4 },
        { name: 'E3', display: 'E', midi: 52, staffPos: 5 },
        { name: 'F3', display: 'F', midi: 53, staffPos: 6 },
        { name: 'G3', display: 'G', midi: 55, staffPos: 7 },
        { name: 'A3', display: 'A', midi: 57, staffPos: 8 },
        { name: 'B3', display: 'B', midi: 59, staffPos: 9 },
        { name: 'C4', display: 'C', midi: 60, staffPos: 10, ledger: 1 }
      ];
      if (acc) {
        notes.push(
          { name: 'Bb2', display: 'B‚ô≠', midi: 46, staffPos: 2, accidental: 'b' },
          { name: 'F#3', display: 'F#', midi: 54, staffPos: 6, accidental: '#' },
          { name: 'Eb3', display: 'E‚ô≠', midi: 51, staffPos: 5, accidental: 'b' }
        );
      }
      return notes;
    }

    // ==================== DRAWING ====================
    function drawStaff(canvas, clef, note, showLabel) {
      var ctx = canvas.getContext('2d');
      var w = 400, h = 200;
      var dpr = window.devicePixelRatio || 1;
      canvas.width = w * dpr; canvas.height = h * dpr;
      canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, w, h);

      var lineGap = 16;
      var staffTop = h / 2 - 2 * lineGap;
      var cx = w / 2;

      // Draw 5 lines
      ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 1.5;
      for (var i = 0; i < 5; i++) {
        var y = staffTop + i * lineGap;
        ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(w - 40, y); ctx.stroke();
      }

      // Clef
      ctx.font = '52px serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)';
      if (clef === 'treble') ctx.fillText('ùÑû', 48, staffTop + 3.8 * lineGap);
      else ctx.fillText('ùÑ¢', 48, staffTop + 2.2 * lineGap);

      if (!note) return;

      var bottomLineY = staffTop + 4 * lineGap;
      var noteY = bottomLineY - note.staffPos * (lineGap / 2);

      // Ledger lines
      ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 1.5;
      if (note.staffPos < 0) {
        for (var p = -2; p >= note.staffPos - 1; p -= 2) {
          var ly = bottomLineY - p * (lineGap / 2);
          ctx.beginPath(); ctx.moveTo(cx - 22, ly); ctx.lineTo(cx + 22, ly); ctx.stroke();
        }
      }
      if (note.staffPos > 8) {
        for (var p = 10; p <= note.staffPos + 1; p += 2) {
          var ly = bottomLineY - p * (lineGap / 2);
          ctx.beginPath(); ctx.moveTo(cx - 22, ly); ctx.lineTo(cx + 22, ly); ctx.stroke();
        }
      }

      // Accidental
      if (note.accidental) {
        ctx.font = '22px serif'; ctx.fillStyle = GOLD;
        ctx.fillText(note.accidental === '#' ? '‚ôØ' : '‚ô≠', cx - 24, noteY + 7);
      }

      // Note head
      ctx.fillStyle = GOLD;
      ctx.beginPath(); ctx.ellipse(cx, noteY, 10, 8, -0.2, 0, Math.PI * 2); ctx.fill();

      // Stem
      ctx.strokeStyle = GOLD; ctx.lineWidth = 2;
      ctx.beginPath();
      if (note.staffPos >= 4) { ctx.moveTo(cx - 9, noteY); ctx.lineTo(cx - 9, noteY + 44); }
      else { ctx.moveTo(cx + 9, noteY); ctx.lineTo(cx + 9, noteY - 44); }
      ctx.stroke();

      // Label
      if (showLabel) {
        ctx.font = 'bold 16px Courier New'; ctx.fillStyle = '#00d4ff'; ctx.textAlign = 'center';
        ctx.fillText(note.name, cx, noteY > staffTop + 2 * lineGap ? noteY - 20 : noteY + 30);
        ctx.textAlign = 'start';
      }
    }

    // ==================== LEARN MODE ====================
    function drawLearnStaves() {
      var dpr = window.devicePixelRatio || 1;
      var lineGap = 14, staffTop = 40;

      // Treble
      var tc = document.getElementById('learnTreble');
      var ctx = tc.getContext('2d');
      tc.width = 500 * dpr; tc.height = 160 * dpr;
      tc.style.width = '500px'; tc.style.height = '160px';
      ctx.scale(dpr, dpr);
      ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 1.5;
      for (var i = 0; i < 5; i++) { var y = staffTop + i * lineGap; ctx.beginPath(); ctx.moveTo(20, y); ctx.lineTo(480, y); ctx.stroke(); }
      ctx.font = '44px serif'; ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillText('ùÑû', 24, staffTop + 3.8 * lineGap);
      var bottomY = staffTop + 4 * lineGap;
      ['E','G','B','D','F'].forEach(function(n, i) {
        var x = 100 + i * 80, y = bottomY - i * lineGap;
        ctx.fillStyle = GOLD; ctx.beginPath(); ctx.ellipse(x, y, 8, 6, -0.2, 0, Math.PI * 2); ctx.fill();
        ctx.font = 'bold 13px Courier New'; ctx.fillStyle = '#00d4ff'; ctx.textAlign = 'center'; ctx.fillText(n, x, y + 22);
      });
      ctx.textAlign = 'start';

      // Bass
      var bc = document.getElementById('learnBass');
      var bctx = bc.getContext('2d');
      bc.width = 500 * dpr; bc.height = 160 * dpr;
      bc.style.width = '500px'; bc.style.height = '160px';
      bctx.scale(dpr, dpr);
      bctx.strokeStyle = 'rgba(255,255,255,0.25)'; bctx.lineWidth = 1.5;
      for (var i = 0; i < 5; i++) { var y = staffTop + i * lineGap; bctx.beginPath(); bctx.moveTo(20, y); bctx.lineTo(480, y); bctx.stroke(); }
      bctx.font = '44px serif'; bctx.fillStyle = 'rgba(255,255,255,0.4)'; bctx.fillText('ùÑ¢', 24, staffTop + 2.2 * lineGap);
      ['G','B','D','F','A'].forEach(function(n, i) {
        var x = 100 + i * 80, y = bottomY - i * lineGap;
        bctx.fillStyle = GOLD; bctx.beginPath(); bctx.ellipse(x, y, 8, 6, -0.2, 0, Math.PI * 2); bctx.fill();
        bctx.font = 'bold 13px Courier New'; bctx.fillStyle = '#00d4ff'; bctx.textAlign = 'center'; bctx.fillText(n, x, y + 22);
      });
      bctx.textAlign = 'start';
    }

    // ==================== IDENTIFY MODE ====================
    var idCurrent = null, idScore = { correct: 0, streak: 0, total: 0 };

    function newIdQuestion() {
      var clefSel = document.getElementById('idClef').value;
      var acc = document.getElementById('idAccidentals').value === 'yes';
      var clef = clefSel === 'both' ? (Math.random() > 0.5 ? 'treble' : 'bass') : clefSel;
      var pool = clef === 'treble' ? getTrebleNotes(acc) : getBassNotes(acc);
      var note = pool[Math.floor(Math.random() * pool.length)];
      idCurrent = { name: note.name, display: note.display, midi: note.midi, staffPos: note.staffPos, accidental: note.accidental, ledger: note.ledger, clef: clef };
      drawStaff(document.getElementById('idStaff'), clef, note, false);
      var answersEl = document.getElementById('idAnswers');
      answersEl.innerHTML = '';
      var baseNotes = acc ? ['C','C#','D','E‚ô≠','E','F','F#','G','A','B‚ô≠','B'] : ['C','D','E','F','G','A','B'];
      baseNotes.forEach(function(n) {
        var btn = document.createElement('button');
        btn.className = 'note-btn' + (n.length > 1 ? ' sharp' : '');
        btn.textContent = n;
        btn.onclick = function() { answerIdent(n, btn); };
        answersEl.appendChild(btn);
      });
      document.getElementById('idResult').className = 'result-msg';
      document.getElementById('idResult').style.display = 'none';
      document.getElementById('idNextBtn').style.display = 'none';
    }

    function answerIdent(answer, btn) {
      var correct = idCurrent.display;
      document.querySelectorAll('#idAnswers .note-btn').forEach(function(b) { b.classList.add('disabled'); });
      idScore.total++;
      var res = document.getElementById('idResult');
      if (answer === correct) {
        btn.classList.add('correct'); idScore.correct++; idScore.streak++;
        res.className = 'result-msg show pass'; res.textContent = '‚úì Correct! That\'s ' + idCurrent.name + '.';
      } else {
        btn.classList.add('wrong'); idScore.streak = 0;
        document.querySelectorAll('#idAnswers .note-btn').forEach(function(b) { if (b.textContent === correct) b.classList.add('correct'); });
        res.className = 'result-msg show fail'; res.textContent = '‚úó That was ' + idCurrent.name + '. You picked ' + answer + '.';
      }
      document.getElementById('idCorrect').textContent = idScore.correct;
      document.getElementById('idStreak').textContent = idScore.streak;
      document.getElementById('idTotal').textContent = idScore.total;
      document.getElementById('idNextBtn').style.display = 'block';
    }

    // ==================== SPEED DRILL ====================
    var spActive = false, spTimerInterval = null, spScore = { correct: 0, wrong: 0 }, spStartTime = 0, spCurrent = null;

    function startSpeedDrill() {
      var dur = parseInt(document.getElementById('spDuration').value);
      spScore = { correct: 0, wrong: 0 }; spActive = true; spStartTime = Date.now();
      document.getElementById('spCorrect').textContent = '0';
      document.getElementById('spWrong').textContent = '0';
      document.getElementById('spTimer').textContent = dur;
      document.getElementById('spFinalResult').className = 'result-msg';
      document.getElementById('spFinalResult').style.display = 'none';
      document.getElementById('spStartBtn').style.display = 'none';
      document.getElementById('speedVal').textContent = '‚Äî';
      newSpeedNote();
      spTimerInterval = setInterval(function() {
        var elapsed = Math.floor((Date.now() - spStartTime) / 1000);
        var remaining = dur - elapsed;
        document.getElementById('spTimer').textContent = Math.max(0, remaining);
        if (remaining <= 0) endSpeedDrill();
      }, 200);
    }

    function newSpeedNote() {
      if (!spActive) return;
      var clefSel = document.getElementById('spClef').value;
      var clef = clefSel === 'both' ? (Math.random() > 0.5 ? 'treble' : 'bass') : clefSel;
      var pool = clef === 'treble' ? getTrebleNotes(false) : getBassNotes(false);
      var note = pool[Math.floor(Math.random() * pool.length)];
      spCurrent = { display: note.display, clef: clef };
      drawStaff(document.getElementById('spStaff'), clef, note, false);
      var answersEl = document.getElementById('spAnswers');
      answersEl.innerHTML = '';
      ['C','D','E','F','G','A','B'].forEach(function(n) {
        var btn = document.createElement('button');
        btn.className = 'note-btn'; btn.textContent = n;
        btn.onclick = function() { answerSpeed(n, btn); };
        answersEl.appendChild(btn);
      });
    }

    function answerSpeed(answer, btn) {
      if (!spActive) return;
      if (answer === spCurrent.display) {
        spScore.correct++; btn.classList.add('correct');
        document.getElementById('spCorrect').textContent = spScore.correct;
      } else {
        spScore.wrong++; btn.classList.add('wrong');
        document.getElementById('spWrong').textContent = spScore.wrong;
      }
      var elapsed = (Date.now() - spStartTime) / 1000;
      if (elapsed > 0) document.getElementById('speedVal').textContent = Math.round((spScore.correct / elapsed) * 60);
      setTimeout(newSpeedNote, 250);
    }

    function endSpeedDrill() {
      spActive = false; clearInterval(spTimerInterval);
      var dur = parseInt(document.getElementById('spDuration').value);
      var npm = Math.round((spScore.correct / dur) * 60);
      document.getElementById('speedVal').textContent = npm;
      var grade = npm >= 60 ? 'üèÜ Virtuoso!' : npm >= 40 ? '‚≠ê Excellent!' : npm >= 25 ? 'üëç Good work!' : 'üí™ Keep practicing!';
      var res = document.getElementById('spFinalResult');
      res.className = 'result-msg show pass';
      res.innerHTML = grade + ' <strong>' + spScore.correct + '</strong> correct, <strong>' + spScore.wrong + '</strong> wrong ‚Äî <strong>' + npm + ' notes/min</strong>';
      document.getElementById('spStartBtn').style.display = 'block';
      document.getElementById('spStartBtn').textContent = '‚ö° Try Again';
      document.getElementById('spAnswers').innerHTML = '';
    }

    // ==================== AUDIO ====================
    var audioCtx = null;
    function getCtx() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }

    function hearCurrentNote() {
      if (!idCurrent) return;
      var ctx = getCtx();
      if (ctx.state === 'suspended') ctx.resume();
      var freq = 440 * Math.pow(2, (idCurrent.midi - 69) / 12);
      var now = ctx.currentTime;

      // Fundamental tone
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = freq;
      var vol = freq < 200 ? 0.5 : 0.3;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(vol, now + 0.04);
      gain.gain.setValueAtTime(vol, now + 1.2);
      gain.gain.linearRampToValueAtTime(0, now + 1.6);
      osc.connect(gain).connect(ctx.destination);
      osc.start(now); osc.stop(now + 1.6);

      // For low notes (bass clef range), add strong upper harmonics
      // so they're clearly audible on laptop/phone speakers
      if (freq < 250) {
        // 1st harmonic (octave) - strong
        var osc2 = ctx.createOscillator();
        var gain2 = ctx.createGain();
        osc2.type = 'triangle';
        osc2.frequency.value = freq * 2;
        var vol2 = freq < 130 ? 0.35 : 0.2;
        gain2.gain.setValueAtTime(0, now);
        gain2.gain.linearRampToValueAtTime(vol2, now + 0.04);
        gain2.gain.setValueAtTime(vol2, now + 1.1);
        gain2.gain.linearRampToValueAtTime(0, now + 1.5);
        osc2.connect(gain2).connect(ctx.destination);
        osc2.start(now); osc2.stop(now + 1.5);

        // 2nd harmonic (octave + fifth) - for very low notes
        if (freq < 130) {
          var osc3 = ctx.createOscillator();
          var gain3 = ctx.createGain();
          osc3.type = 'sine';
          osc3.frequency.value = freq * 3;
          gain3.gain.setValueAtTime(0, now);
          gain3.gain.linearRampToValueAtTime(0.12, now + 0.04);
          gain3.gain.setValueAtTime(0.12, now + 1.0);
          gain3.gain.linearRampToValueAtTime(0, now + 1.4);
          osc3.connect(gain3).connect(ctx.destination);
          osc3.start(now); osc3.stop(now + 1.4);
        }
      }
    }

    // ==================== MODE SWITCHING ====================
    function switchMode(mode) {
      document.querySelectorAll('.mode-tab').forEach(function(t, i) {
        t.classList.toggle('active', ['learn','identify','speed'][i] === mode);
      });
      document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('panel-' + mode).classList.add('active');
      if (mode === 'identify' && !idCurrent) newIdQuestion();
    }

    // Init
    drawLearnStaves();
    newIdQuestion();
  </script>
</body>
</html>