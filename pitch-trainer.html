<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pitch Trainer ‚Äî Practice Pitch Accuracy | VoiceStry</title>
  <meta name="description" content="Interactive pitch training tool. Hear a note, sing it back, and get real-time visual feedback on your accuracy. Learn intervals, match pitch, and train your ear.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé§</text></svg>">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-purple: #9d4edd;
      --accent-cyan: #00d4ff;
      --accent-gold: #ffd700;
      --accent-pink: #ff6b9d;
      --accent-green: #4ade80;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
    }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.7; }

    /* Webring */
    .aiunites-bar{background:linear-gradient(90deg,#0a0a0f,#1a1a2e);border-bottom:1px solid rgba(99,102,241,.3);padding:8px 0;font-size:12px}
    .aiunites-bar-content{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;align-items:center;gap:12px;overflow-x:auto;scrollbar-width:none}
    .aiunites-bar-content::-webkit-scrollbar{display:none}
    .aiunites-bar a{color:rgba(255,255,255,.7);text-decoration:none;white-space:nowrap;transition:color .2s}
    .aiunites-bar a:hover{color:#fff}
    .aiunites-bar-brand{color:#6366f1!important;font-weight:600}
    .aiunites-bar-divider{color:rgba(255,255,255,.2)}

    /* Nav */
    .nav { background: var(--bg-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
    .nav-logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .nav-links { display: flex; gap: 25px; flex-wrap: wrap; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
    .nav-links a:hover, .nav-links a.active { color: var(--accent-cyan); }

    /* Hero */
    .hero { padding: 50px 20px 30px; text-align: center; background: radial-gradient(ellipse at 50% 30%, rgba(0, 212, 255, 0.15) 0%, transparent 60%), var(--bg-dark); }
    .hero h1 { font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 12px; background: linear-gradient(135deg, var(--accent-cyan), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero-sub { font-size: 1.05rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }

    /* Main */
    .main { max-width: 800px; margin: 0 auto; padding: 30px 20px 80px; }

    /* Mode Tabs */
    .mode-tabs { display: flex; gap: 0; margin-bottom: 30px; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .mode-tab {
      flex: 1; padding: 14px; text-align: center; cursor: pointer;
      background: var(--bg-card); color: var(--text-secondary);
      font-weight: 700; font-size: 0.95rem; border: none;
      transition: all 0.2s; font-family: inherit;
    }
    .mode-tab:hover { background: rgba(255,255,255,0.04); }
    .mode-tab.active { background: var(--accent-purple); color: #fff; }

    /* Panels */
    .panel { display: none; }
    .panel.active { display: block; }

    /* Pitch Display */
    .pitch-hero {
      text-align: center; padding: 40px 20px;
      background: var(--bg-card); border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 25px;
      position: relative; overflow: hidden;
    }
    .pitch-hero::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(0, 212, 255, 0.08), transparent 70%);
    }
    .pitch-note { font-size: 5rem; font-weight: 900; color: var(--accent-gold); font-family: 'Courier New', monospace; position: relative; }
    .pitch-freq { font-size: 1.2rem; color: var(--text-secondary); margin-top: 5px; position: relative; }
    .pitch-cents {
      font-size: 1.4rem; font-weight: 800; margin-top: 10px; position: relative;
      transition: color 0.15s;
    }
    .pitch-cents.sharp { color: var(--accent-red); }
    .pitch-cents.flat { color: var(--accent-orange); }
    .pitch-cents.intune { color: var(--accent-green); }

    /* Meter */
    .meter-wrap { position: relative; height: 30px; margin: 20px 40px 0; border-radius: 15px; background: rgba(255,255,255,0.04); overflow: visible; }
    .meter-center { position: absolute; left: 50%; top: -4px; bottom: -4px; width: 3px; background: var(--accent-green); border-radius: 2px; transform: translateX(-50%); z-index: 2; }
    .meter-needle {
      position: absolute; top: 2px; bottom: 2px; width: 10px; border-radius: 5px;
      background: var(--accent-cyan); transition: left 0.08s ease-out; z-index: 3;
      box-shadow: 0 0 12px rgba(0, 212, 255, 0.6);
    }
    .meter-labels { display: flex; justify-content: space-between; margin: 6px 40px 0; font-size: 0.75rem; color: var(--text-secondary); }

    /* Start Button */
    .start-btn {
      display: block; margin: 0 auto; padding: 16px 40px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      border: none; border-radius: 14px; color: #fff;
      font-size: 1.1rem; font-weight: 800; cursor: pointer;
      font-family: inherit; transition: all 0.2s;
    }
    .start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(157, 78, 221, 0.4); }
    .start-btn.recording { background: linear-gradient(135deg, var(--accent-red), var(--accent-orange)); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 0 0 14px rgba(239,68,68,0); } }

    /* Match mode */
    .match-target {
      text-align: center; padding: 25px;
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(0, 212, 255, 0.05));
      border-radius: 16px; border: 1px solid rgba(157, 78, 221, 0.2);
      margin-bottom: 20px;
    }
    .match-label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
    .match-note { font-size: 2.5rem; font-weight: 900; color: var(--accent-gold); font-family: 'Courier New', monospace; }
    .match-play {
      display: inline-block; margin-top: 12px; padding: 10px 24px;
      background: rgba(0, 212, 255, 0.15); border: 1px solid rgba(0, 212, 255, 0.3);
      color: var(--accent-cyan); border-radius: 10px; cursor: pointer;
      font-weight: 700; font-family: inherit; font-size: 0.9rem; transition: all 0.2s;
    }
    .match-play:hover { background: rgba(0, 212, 255, 0.25); }

    .match-result {
      text-align: center; padding: 20px; border-radius: 14px; margin: 15px 0;
      font-size: 1.1rem; font-weight: 700; display: none;
    }
    .match-result.show { display: block; }
    .match-result.great { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); color: var(--accent-green); }
    .match-result.close { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--accent-orange); }
    .match-result.off { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--accent-red); }

    .score-bar { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .score-item { text-align: center; }
    .score-num { font-size: 2rem; font-weight: 900; font-family: 'Courier New', monospace; }
    .score-label { font-size: 0.8rem; color: var(--text-secondary); }

    .next-note-btn {
      display: block; margin: 15px auto 0; padding: 12px 28px;
      background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
      border: none; color: #000; border-radius: 12px; font-weight: 800;
      cursor: pointer; font-family: inherit; font-size: 0.95rem; transition: all 0.2s;
    }
    .next-note-btn:hover { transform: translateY(-2px); }

    /* Interval mode */
    .interval-card {
      background: var(--bg-card); border-radius: 16px; padding: 25px;
      border: 1px solid rgba(255,255,255,0.06); margin-bottom: 20px; text-align: center;
    }
    .interval-name { font-size: 1.4rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 5px; }
    .interval-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; }
    .interval-notes { font-family: 'Courier New', monospace; font-size: 1.8rem; color: var(--accent-cyan); font-weight: 700; margin: 10px 0; }
    .interval-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
    .interval-btn {
      padding: 10px 20px; border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.1); color: var(--accent-cyan);
      cursor: pointer; font-weight: 700; font-family: inherit; font-size: 0.9rem; transition: all 0.2s;
    }
    .interval-btn:hover { background: rgba(0, 212, 255, 0.2); }

    .quiz-opts { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .quiz-opt {
      padding: 12px 20px; border-radius: 12px;
      background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1);
      color: var(--text-primary); cursor: pointer; font-weight: 700;
      font-family: inherit; font-size: 0.9rem; transition: all 0.2s;
    }
    .quiz-opt:hover { border-color: var(--accent-purple); }
    .quiz-opt.correct { border-color: var(--accent-green); background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
    .quiz-opt.wrong { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }
    .quiz-opt.disabled { pointer-events: none; opacity: 0.6; }

    /* Settings */
    .settings-row {
      display: flex; align-items: center; gap: 15px; padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .settings-row label { flex: 1; color: var(--text-secondary); font-size: 0.9rem; }
    .settings-row select {
      background: var(--bg-card); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px; border-radius: 8px; font-family: inherit;
    }

    /* Voice Confidence Indicator */
    .voice-conf{display:flex;align-items:center;gap:10px;margin-top:14px;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:10px}
    .voice-conf-label{font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;min-width:52px}
    .voice-conf-track{flex:1;height:5px;background:rgba(255,255,255,0.06);border-radius:5px;overflow:hidden}
    .voice-conf-fill{height:100%;border-radius:5px;transition:width 0.15s,background 0.3s}
    .voice-conf-status{font-size:0.72rem;font-weight:700;font-family:'Courier New',monospace;min-width:70px;text-align:right;transition:color 0.3s}
    .voice-conf-status.noise{color:var(--accent-red)}
    .voice-conf-status.maybe{color:var(--accent-orange)}
    .voice-conf-status.voice{color:var(--accent-green)}
    .voice-conf-status.singing{color:var(--accent-cyan)}

    /* Footer */
    .footer { background: var(--bg-card); padding: 40px 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
    .footer p { color: var(--text-secondary); font-size: 0.9rem; }
    .footer a { color: var(--accent-purple); text-decoration: none; }

    @media (max-width: 768px) {
      .nav { flex-direction: column; gap: 12px; }
      .nav-links { flex-wrap: wrap; justify-content: center; gap: 12px; }
      .mode-tabs { flex-direction: column; }
      .pitch-note { font-size: 3.5rem; }
      .meter-wrap, .meter-labels { margin-left: 10px; margin-right: 10px; }
    }
  </style>
</head>
<body>

  <!-- Webring -->
  <div class="aiunites-bar"><div class="aiunites-bar-content"><a href="https://aiunites.github.io/aiunites-site/" class="aiunites-bar-brand">‚óÜ AIUNITES</a><span class="aiunites-bar-divider">|</span><a href="https://aiunites.github.io/aizines-app/">AIZines</a><a href="https://aiunites.github.io/aibyjob-demo/">AIByJob</a><a href="https://aiunites.github.io/redomy-demo/">Redomy</a><a href="https://aiunites.github.io/videobate-site/">VideoBate</a><a href="https://aiunites.github.io/voicestry-site/" style="color:var(--accent-green) !important;font-weight:600;">üé§ VoiceStry</a><a href="https://aiunites.github.io/furnishthings-site/">FurnishThings</a><a href="https://aiunites.github.io/bizstry-site/">BizStry</a><a href="https://aiunites.github.io/aiyhwh-site/">AI YHWH</a><a href="https://aiunites.github.io/cloudsion-site/">Cloudsion</a><a href="https://aiunites.github.io/gameatica-site/">Gameatica</a><a href="https://aiunites.github.io/uptownit-site/">UptownIT</a><a href="https://aiunites.github.io/inthisworld-site/">InThisWorld</a><a href="https://aiunites.github.io/erpise-site/">ERPise</a><a href="https://aiunites.github.io/erpize-site/">ERPize</a><a href="https://aiunites.github.io/cosmostheopera-site/">üåå COSMOS</a></div></div>

  <nav class="nav">
    <a href="index.html" class="nav-logo">üé§ VoiceStry</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="vrn-method.html">VRN Method</a>
      <a href="learn.html">Learn VRN</a>
      <a href="5-gears.html">5 Gears</a>
      <a href="vocal-gym.html">Vocal Gym</a>
      <a href="pitch-trainer.html" class="active">Pitch Trainer</a>
      <a href="sight-reading.html">Sight Reading</a>
      <a href="press.html">Press</a>
    </div>
  </nav>

  <section class="hero">
    <a href="vrn-method.html" style="display:inline-block;margin-bottom:18px;color:var(--accent-cyan);text-decoration:none;font-size:0.95rem;opacity:0.8;transition:opacity .2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">‚Üê Back to VRN Method</a>
    <h1>üé§ Pitch Trainer</h1>
    <p class="hero-sub">Train your ear and voice. Hear a note, sing it back, and see in real time how accurate you are. Your microphone becomes your teacher.</p>
  </section>

  <main class="main">

    <div class="mode-tabs">
      <button class="mode-tab active" onclick="switchMode('free')">üéô Free Pitch</button>
      <button class="mode-tab" onclick="switchMode('match')">üéØ Match Pitch</button>
      <button class="mode-tab" onclick="switchMode('interval')">üéµ Intervals</button>
    </div>

    <!-- FREE PITCH MODE -->
    <div class="panel active" id="panel-free">
      <div class="pitch-hero">
        <div class="pitch-note" id="freeNote">‚Äî</div>
        <div class="pitch-freq" id="freeFreq">Sing or hum to begin</div>
        <div class="pitch-cents" id="freeCents">&nbsp;</div>
        <div class="meter-wrap">
          <div class="meter-center"></div>
          <div class="meter-needle" id="freeNeedle" style="left: calc(50% - 5px);"></div>
        </div>
        <div class="meter-labels"><span>‚ô≠ Flat</span><span>‚úì In Tune</span><span>‚ôØ Sharp</span></div>
      </div>
      <div class="voice-conf" id="freeVoiceConf" style="max-width:500px;margin:0 auto 15px">
        <div class="voice-conf-label">Signal</div>
        <div class="voice-conf-track"><div class="voice-conf-fill" id="freeConfFill" style="width:0%;background:var(--accent-red)"></div></div>
        <div class="voice-conf-status noise" id="freeConfStatus">Silence</div>
      </div>
      <button class="start-btn" id="freeStartBtn" onclick="toggleFreeMic()">üé§ Start Listening</button>
      <p style="text-align:center; color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px;">Sing any note ‚Äî the display shows your pitch, note name, and how many cents sharp or flat you are.</p>
    </div>

    <!-- MATCH PITCH MODE -->
    <div class="panel" id="panel-match">
      <div class="score-bar">
        <div class="score-item"><div class="score-num" style="color: var(--accent-green);" id="matchCorrect">0</div><div class="score-label">Correct</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--accent-cyan);" id="matchStreak">0</div><div class="score-label">Streak</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--text-secondary);" id="matchTotal">0</div><div class="score-label">Attempts</div></div>
      </div>

      <div class="match-target">
        <div class="match-label">Sing this note:</div>
        <div class="match-note" id="matchTargetNote">C4</div>
        <button class="match-play" onclick="playMatchTarget()">‚ñ∂ Hear the note</button>
      </div>

      <div class="pitch-hero" style="padding: 25px;">
        <div class="pitch-note" id="matchYourNote" style="font-size: 3rem;">‚Äî</div>
        <div class="pitch-cents" id="matchCents">&nbsp;</div>
        <div class="meter-wrap">
          <div class="meter-center"></div>
          <div class="meter-needle" id="matchNeedle" style="left: calc(50% - 5px);"></div>
        </div>
        <div class="meter-labels"><span>‚ô≠ Flat</span><span>‚úì In Tune</span><span>‚ôØ Sharp</span></div>
      </div>

      <div class="voice-conf" id="matchVoiceConf" style="max-width:500px;margin:0 auto 15px">
        <div class="voice-conf-label">Signal</div>
        <div class="voice-conf-track"><div class="voice-conf-fill" id="matchConfFill" style="width:0%;background:var(--accent-red)"></div></div>
        <div class="voice-conf-status noise" id="matchConfStatus">Silence</div>
      </div>
      <div class="match-result" id="matchResult"></div>
      <button class="start-btn" id="matchStartBtn" onclick="toggleMatchMic()">üé§ Start Singing</button>
      <button class="next-note-btn" id="nextNoteBtn" onclick="nextMatchNote()" style="display:none;">Next Note ‚Üí</button>

      <div style="margin-top: 20px;">
        <div class="settings-row">
          <label>Range:</label>
          <select id="matchRange" onchange="nextMatchNote()">
            <option value="easy">Easy (C3‚ÄìC4)</option>
            <option value="medium" selected>Medium (A2‚ÄìA4)</option>
            <option value="hard">Hard (E2‚ÄìE5)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- INTERVAL MODE -->
    <div class="panel" id="panel-interval">
      <div class="score-bar">
        <div class="score-item"><div class="score-num" style="color: var(--accent-green);" id="intCorrect">0</div><div class="score-label">Correct</div></div>
        <div class="score-item"><div class="score-num" style="color: var(--accent-cyan);" id="intStreak">0</div><div class="score-label">Streak</div></div>
      </div>

      <div class="interval-card">
        <div class="interval-desc">Listen to the two notes, then identify the interval:</div>
        <div class="interval-notes" id="intNotes">? ‚Üí ?</div>
        <div class="interval-btns">
          <button class="interval-btn" onclick="playIntervalQ('first')">‚ñ∂ First Note</button>
          <button class="interval-btn" onclick="playIntervalQ('second')">‚ñ∂ Second Note</button>
          <button class="interval-btn" onclick="playIntervalQ('both')">‚ñ∂ Play Both</button>
        </div>
      </div>

      <div class="quiz-opts" id="intOpts"></div>
      <div class="match-result" id="intResult"></div>
      <button class="next-note-btn" id="nextIntBtn" onclick="newIntervalQ()" style="display:none;">Next Interval ‚Üí</button>

      <div style="margin-top: 20px;">
        <div class="settings-row">
          <label>Difficulty:</label>
          <select id="intDifficulty" onchange="newIntervalQ()">
            <option value="basic" selected>Basic (2nds, 3rds, 5ths, octave)</option>
            <option value="intermediate">Intermediate (all diatonic)</option>
            <option value="advanced">Advanced (chromatic)</option>
          </select>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer">
    <p>
      ¬© 2002-2026 VoiceStry. All Rights Reserved. DMCA Protected.<br>
      Home of the <a href="vrn-method.html">VRN Method</a> ‚Äî Vocal Resonance Notation<br><br>
      <a href="index.html">Home</a> |
      <a href="vrn-method.html">VRN Method</a> |
      <a href="learn.html">Learn</a> |
      <a href="5-gears.html">5 Gears</a> |
      <a href="vocal-gym.html">Vocal Gym</a> |
      <a href="pitch-trainer.html">Pitch</a> |
      <a href="sight-reading.html">Sight Reading</a> |
      <a href="voice-lab.html">Voice Lab</a> |
      <a href="press.html">Press</a><br><br>
      Part of the <a href="https://aiunites.github.io/aiunites-site/">AIUNITES</a> network |
      Created by <a href="https://aiunites.github.io/cosmostheopera-site/">COSMOS the OPERA</a>
    </p>
    <div style="max-width:680px;margin:1.5rem auto 0;padding:1rem 1.5rem;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:0.8rem;line-height:1.5;color:rgba(255,255,255,0.7);">
      <strong style="color:#f87171;">&#9888;&#65039; Voice Health Disclaimer:</strong> VoiceStry is an educational tool and is not a substitute for professional vocal instruction or medical advice. Stop immediately if you experience pain, strain, hoarseness, or discomfort while singing. Consult a vocal coach or ENT specialist before beginning any intensive vocal training program. VoiceStry and AIUNITES are not responsible for vocal injury resulting from misuse of exercises or tools on this site.
    </div>
    <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid rgba(255,255,255,0.1);font-size:0.75rem;color:rgba(255,255,255,0.4);text-align:center;">
      <a href="#" style="color:rgba(255,255,255,0.4);margin:0 8px;">Privacy Policy</a> &middot;
      <a href="#" style="color:rgba(255,255,255,0.4);margin:0 8px;">Terms of Service</a> &middot;
      <a href="https://github.com/AIUNITES/voicestry-site/issues" target="_blank" style="color:rgba(255,255,255,0.4);margin:0 8px;">Developer Feedback</a>
    </div>
  </footer>

  <script>
    // ==================== AUDIO & PITCH CORE ====================
    var NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    var A4 = 440;

    function midiToFreq(midi) { return A4 * Math.pow(2, (midi - 69) / 12); }
    function freqToMidi(f) { return 12 * Math.log2(f / A4) + 69; }
    function midiToName(midi) { return NOTE_NAMES[Math.round(midi) % 12] + (Math.floor(Math.round(midi) / 12) - 1); }

    var audioCtx = null;
    function getCtx() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }

    function playTone(freq, duration) {
      duration = duration || 1.5;
      var ctx = getCtx();
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.08);
      gain.gain.setValueAtTime(0.2, ctx.currentTime + duration - 0.3);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
      osc.connect(gain).connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + duration);
    }

    function detectPitch(buf, sampleRate) {
      var maxVal = 0;
      for (var i = 0; i < buf.length; i++) if (Math.abs(buf[i]) > maxVal) maxVal = Math.abs(buf[i]);
      if (maxVal < 0.01) return -1;
      var norm = new Float32Array(buf.length);
      for (var i = 0; i < buf.length; i++) norm[i] = buf[i] / maxVal;
      var minP = Math.floor(sampleRate / 1100);
      var maxP = Math.floor(sampleRate / 55);
      var bestCorr = 0, bestP = 0;
      for (var p = minP; p < maxP && p < norm.length / 2; p++) {
        var corr = 0;
        for (var i = 0; i < norm.length / 2; i++) corr += norm[i] * norm[i + p];
        if (corr > bestCorr) { bestCorr = corr; bestP = p; }
      }
      if (bestCorr < norm.length * 0.008) return -1;
      return sampleRate / bestP;
    }

    // ==================== VOICE ISOLATION ENGINE ====================
    function getSpectralFlatness(freqData) {
      var logSum = 0, linSum = 0, count = 0;
      for (var i = 2; i < Math.min(freqData.length, 300); i++) {
        var val = Math.max(freqData[i], 0.001);
        logSum += Math.log(val); linSum += val; count++;
      }
      if (count === 0 || linSum === 0) return 1;
      return Math.exp(logSum / count) / (linSum / count);
    }

    function getHNR(freqData, fundamental, sampleRate, fftSize) {
      if (fundamental <= 0) return 0;
      var binHz = sampleRate / fftSize;
      var harmonicE = 0, totalE = 0;
      var lo = Math.max(1, Math.floor(80 / binHz));
      var hi = Math.min(freqData.length - 1, Math.floor(5000 / binHz));
      for (var i = lo; i <= hi; i++) totalE += freqData[i] * freqData[i];
      for (var h = 1; h <= 10; h++) {
        var hBin = Math.round((fundamental * h) / binHz);
        if (hBin >= freqData.length) break;
        for (var j = Math.max(0, hBin - 2); j <= Math.min(freqData.length - 1, hBin + 2); j++)
          harmonicE += freqData[j] * freqData[j];
      }
      return totalE > 0 ? harmonicE / totalE : 0;
    }

    function getPitchStability(history) {
      if (history.length < 4) return 0;
      var recent = history.slice(-12);
      var mean = 0;
      for (var i = 0; i < recent.length; i++) mean += recent[i];
      mean /= recent.length;
      if (mean === 0) return 0;
      var sumSq = 0;
      for (var i = 0; i < recent.length; i++) {
        var c = 1200 * Math.log2(recent[i] / mean);
        sumSq += c * c;
      }
      return Math.max(0, Math.min(1, 1 - (Math.sqrt(sumSq / recent.length) / 200)));
    }

    function getVoiceConfidence(freq, freqData, timeBuf, sampleRate, fftSize, pitchHist) {
      var rms = 0;
      for (var i = 0; i < timeBuf.length; i++) rms += timeBuf[i] * timeBuf[i];
      rms = Math.sqrt(rms / timeBuf.length);
      if (rms < 0.008) return { score: 0, label: 'Silence' };
      var score = 0;
      if (freq > 0 && freq >= 65 && freq <= 1400) score += 25;
      var flatness = getSpectralFlatness(freqData);
      if (flatness < 0.3) score += 25; else if (flatness < 0.5) score += 15; else if (flatness < 0.7) score += 5;
      var hnr = freq > 0 ? getHNR(freqData, freq, sampleRate, fftSize) : 0;
      if (hnr > 0.5) score += 25; else if (hnr > 0.3) score += 15; else if (hnr > 0.15) score += 5;
      var stab = getPitchStability(pitchHist);
      if (stab > 0.7) score += 25; else if (stab > 0.4) score += 15; else if (stab > 0.2) score += 5;
      var label;
      if (score >= 75) label = 'Singing'; else if (score >= 50) label = 'Voice'; else if (score >= 25) label = 'Maybe'; else label = 'Noise';
      return { score: score, label: label };
    }

    function updateConfUI(fillId, statusId, conf) {
      var fill = document.getElementById(fillId);
      var status = document.getElementById(statusId);
      var pct = Math.min(100, conf.score);
      fill.style.width = pct + '%';
      if (conf.label === 'Singing') {
        fill.style.background = 'var(--accent-cyan)'; status.className = 'voice-conf-status singing'; status.textContent = '\u266B Singing';
      } else if (conf.label === 'Voice') {
        fill.style.background = 'var(--accent-green)'; status.className = 'voice-conf-status voice'; status.textContent = '\u2713 Voice';
      } else if (conf.label === 'Maybe') {
        fill.style.background = 'var(--accent-orange)'; status.className = 'voice-conf-status maybe'; status.textContent = '? Uncertain';
      } else if (conf.label === 'Noise') {
        fill.style.background = 'var(--accent-red)'; status.className = 'voice-conf-status noise'; status.textContent = '\u2718 Noise';
      } else {
        fill.style.width = '0%'; status.className = 'voice-conf-status noise'; status.textContent = 'Silence';
      }
    }

    // Voice isolation tracking per mode
    var freeFreqHist = [], matchFreqHist = [];

    // ==================== MODE SWITCHING ====================
    function switchMode(mode) {
      document.querySelectorAll('.mode-tab').forEach(function(t, i) {
        t.classList.toggle('active', ['free','match','interval'][i] === mode);
      });
      document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('panel-' + mode).classList.add('active');
      if (mode === 'interval' && !currentInterval) newIntervalQ();
      if (mode === 'match' && !matchTarget) nextMatchNote();
    }

    // ==================== FREE PITCH MODE ====================
    var freeMicStream = null, freeAnalyser = null, freeRaf = null;

    function toggleFreeMic() {
      if (freeMicStream) { stopFreeMic(); return; }
      startFreeMic();
    }

    function startFreeMic() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        var ctx = getCtx();
        var src = ctx.createMediaStreamSource(stream);
        freeAnalyser = ctx.createAnalyser();
        freeAnalyser.fftSize = 4096;
        src.connect(freeAnalyser);
        freeMicStream = stream;
        document.getElementById('freeStartBtn').classList.add('recording');
        document.getElementById('freeStartBtn').textContent = '‚èπ Stop Listening';
        drawFreePitch();
      }).catch(function() { alert('Microphone access needed for pitch detection.'); });
    }

    function stopFreeMic() {
      if (freeMicStream) freeMicStream.getTracks().forEach(function(t) { t.stop(); });
      freeMicStream = null;
      cancelAnimationFrame(freeRaf);
      document.getElementById('freeStartBtn').classList.remove('recording');
      document.getElementById('freeStartBtn').textContent = 'üé§ Start Listening';
      document.getElementById('freeNote').textContent = '‚Äî';
      document.getElementById('freeFreq').textContent = 'Sing or hum to begin';
      document.getElementById('freeCents').innerHTML = '&nbsp;';
      document.getElementById('freeNeedle').style.left = 'calc(50% - 5px)';
    }

    function drawFreePitch() {
      freeRaf = requestAnimationFrame(drawFreePitch);
      if (!freeAnalyser) return;
      var buf = new Float32Array(freeAnalyser.fftSize);
      var freqBuf = new Uint8Array(freeAnalyser.frequencyBinCount);
      freeAnalyser.getFloatTimeDomainData(buf);
      freeAnalyser.getByteFrequencyData(freqBuf);
      var sr = getCtx().sampleRate;
      var freq = detectPitch(buf, sr);

      // Track pitch history for stability
      if (freq > 0) { freeFreqHist.push(freq); if (freeFreqHist.length > 20) freeFreqHist.shift(); }
      else { freeFreqHist = []; }

      // Voice confidence check
      var conf = getVoiceConfidence(freq, freqBuf, buf, sr, freeAnalyser.fftSize, freeFreqHist);
      updateConfUI('freeConfFill', 'freeConfStatus', conf);

      if (freq < 0) return;
      if (conf.score < 50) {
        document.getElementById('freeNote').textContent = midiToName(Math.round(freqToMidi(freq)));
        document.getElementById('freeNote').style.opacity = '0.3';
        document.getElementById('freeFreq').textContent = freq.toFixed(1) + ' Hz';
        return;
      }
      document.getElementById('freeNote').style.opacity = '1';
      var midi = freqToMidi(freq);
      var nearestMidi = Math.round(midi);
      var cents = Math.round((midi - nearestMidi) * 100);
      document.getElementById('freeNote').textContent = midiToName(nearestMidi);
      document.getElementById('freeFreq').textContent = freq.toFixed(1) + ' Hz';
      var centsEl = document.getElementById('freeCents');
      if (Math.abs(cents) <= 5) {
        centsEl.textContent = '‚úì In tune!';
        centsEl.className = 'pitch-cents intune';
      } else {
        centsEl.textContent = (cents > 0 ? '+' : '') + cents + ' cents ' + (cents > 0 ? '‚ôØ' : '‚ô≠');
        centsEl.className = 'pitch-cents ' + (cents > 0 ? 'sharp' : 'flat');
      }
      var pct = 50 + (cents / 50) * 45;
      document.getElementById('freeNeedle').style.left = 'calc(' + Math.max(2, Math.min(98, pct)) + '% - 5px)';
    }

    // ==================== MATCH PITCH MODE ====================
    var matchTarget = null, matchMicStream = null, matchAnalyser = null, matchRaf = null;
    var matchScore = { correct: 0, streak: 0, total: 0 };
    var matchHeldFrames = 0, matchLocked = false;

    function getMatchRange() {
      var r = document.getElementById('matchRange').value;
      if (r === 'easy') return [48, 60];
      if (r === 'hard') return [40, 76];
      return [45, 69];
    }

    function nextMatchNote() {
      var range = getMatchRange();
      var midi = range[0] + Math.floor(Math.random() * (range[1] - range[0] + 1));
      matchTarget = midi;
      document.getElementById('matchTargetNote').textContent = midiToName(midi);
      document.getElementById('matchResult').className = 'match-result';
      document.getElementById('matchResult').style.display = 'none';
      document.getElementById('nextNoteBtn').style.display = 'none';
      document.getElementById('matchYourNote').textContent = '‚Äî';
      document.getElementById('matchCents').innerHTML = '&nbsp;';
      document.getElementById('matchNeedle').style.left = 'calc(50% - 5px)';
      matchHeldFrames = 0; matchLocked = false;
    }

    function playMatchTarget() {
      if (matchTarget) playTone(midiToFreq(matchTarget), 2);
    }

    function toggleMatchMic() {
      if (matchMicStream) { stopMatchMic(); return; }
      startMatchMic();
    }

    function startMatchMic() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        var ctx = getCtx();
        var src = ctx.createMediaStreamSource(stream);
        matchAnalyser = ctx.createAnalyser();
        matchAnalyser.fftSize = 4096;
        src.connect(matchAnalyser);
        matchMicStream = stream;
        document.getElementById('matchStartBtn').classList.add('recording');
        document.getElementById('matchStartBtn').textContent = '‚èπ Stop';
        drawMatchPitch();
      }).catch(function() { alert('Microphone access needed.'); });
    }

    function stopMatchMic() {
      if (matchMicStream) matchMicStream.getTracks().forEach(function(t) { t.stop(); });
      matchMicStream = null;
      cancelAnimationFrame(matchRaf);
      document.getElementById('matchStartBtn').classList.remove('recording');
      document.getElementById('matchStartBtn').textContent = 'üé§ Start Singing';
    }

    function drawMatchPitch() {
      matchRaf = requestAnimationFrame(drawMatchPitch);
      if (!matchAnalyser || matchLocked) return;
      var buf = new Float32Array(matchAnalyser.fftSize);
      var freqBuf = new Uint8Array(matchAnalyser.frequencyBinCount);
      matchAnalyser.getFloatTimeDomainData(buf);
      matchAnalyser.getByteFrequencyData(freqBuf);
      var sr = getCtx().sampleRate;
      var freq = detectPitch(buf, sr);

      // Track pitch history for stability
      if (freq > 0) { matchFreqHist.push(freq); if (matchFreqHist.length > 20) matchFreqHist.shift(); }
      else { matchFreqHist = []; }

      // Voice confidence check
      var conf = getVoiceConfidence(freq, freqBuf, buf, sr, matchAnalyser.fftSize, matchFreqHist);
      updateConfUI('matchConfFill', 'matchConfStatus', conf);

      if (freq < 0) { matchHeldFrames = 0; return; }
      if (conf.score < 50) { matchHeldFrames = 0; return; }
      var midi = freqToMidi(freq);
      var nearestMidi = Math.round(midi);
      var centsFromTarget = Math.round((midi - matchTarget) * 100);
      document.getElementById('matchYourNote').textContent = midiToName(nearestMidi);
      var centsEl = document.getElementById('matchCents');
      if (Math.abs(centsFromTarget) <= 10) {
        centsEl.textContent = '‚úì On target!';
        centsEl.className = 'pitch-cents intune';
      } else {
        centsEl.textContent = (centsFromTarget > 0 ? '+' : '') + centsFromTarget + ' cents';
        centsEl.className = 'pitch-cents ' + (centsFromTarget > 0 ? 'sharp' : 'flat');
      }
      var pct = 50 + (centsFromTarget / 100) * 45;
      document.getElementById('matchNeedle').style.left = 'calc(' + Math.max(2, Math.min(98, pct)) + '% - 5px)';
      if (Math.abs(centsFromTarget) <= 15) matchHeldFrames++;
      else matchHeldFrames = Math.max(0, matchHeldFrames - 2);

      if (matchHeldFrames >= 30) {
        matchLocked = true;
        matchScore.total++;
        var absCents = Math.abs(centsFromTarget);
        var res = document.getElementById('matchResult');
        if (absCents <= 10) {
          matchScore.correct++; matchScore.streak++;
          res.className = 'match-result show great';
          res.textContent = 'üéØ Excellent! Within ' + absCents + ' cents!';
        } else if (absCents <= 25) {
          matchScore.correct++; matchScore.streak++;
          res.className = 'match-result show close';
          res.textContent = 'üëç Close! ' + centsFromTarget + ' cents ‚Äî keep refining.';
        } else {
          matchScore.streak = 0;
          res.className = 'match-result show off';
          res.textContent = 'üîÑ Off by ' + centsFromTarget + ' cents. Try listening again!';
        }
        document.getElementById('matchCorrect').textContent = matchScore.correct;
        document.getElementById('matchStreak').textContent = matchScore.streak;
        document.getElementById('matchTotal').textContent = matchScore.total;
        document.getElementById('nextNoteBtn').style.display = 'block';
      }
    }

    // ==================== INTERVAL MODE ====================
    var INTERVALS = {
      basic: [
        { name: 'Minor 2nd', semi: 1, hint: 'Jaws theme' },
        { name: 'Major 2nd', semi: 2, hint: 'Do-Re (scale step)' },
        { name: 'Minor 3rd', semi: 3, hint: 'Greensleeves' },
        { name: 'Major 3rd', semi: 4, hint: 'Oh When the Saints' },
        { name: 'Perfect 5th', semi: 7, hint: 'Star Wars' },
        { name: 'Octave', semi: 12, hint: 'Somewhere Over the Rainbow' }
      ],
      intermediate: [
        { name: 'Minor 2nd', semi: 1 }, { name: 'Major 2nd', semi: 2 },
        { name: 'Minor 3rd', semi: 3 }, { name: 'Major 3rd', semi: 4 },
        { name: 'Perfect 4th', semi: 5, hint: 'Here Comes the Bride' },
        { name: 'Tritone', semi: 6, hint: 'The Simpsons' },
        { name: 'Perfect 5th', semi: 7 }, { name: 'Minor 6th', semi: 8 },
        { name: 'Major 6th', semi: 9, hint: 'My Bonnie Lies Over' },
        { name: 'Minor 7th', semi: 10 }, { name: 'Major 7th', semi: 11 },
        { name: 'Octave', semi: 12 }
      ],
      advanced: [
        { name: 'Minor 2nd', semi: 1 }, { name: 'Major 2nd', semi: 2 },
        { name: 'Minor 3rd', semi: 3 }, { name: 'Major 3rd', semi: 4 },
        { name: 'Perfect 4th', semi: 5 }, { name: 'Tritone', semi: 6 },
        { name: 'Perfect 5th', semi: 7 }, { name: 'Minor 6th', semi: 8 },
        { name: 'Major 6th', semi: 9 }, { name: 'Minor 7th', semi: 10 },
        { name: 'Major 7th', semi: 11 }, { name: 'Octave', semi: 12 }
      ]
    };

    var currentInterval = null, intScore = { correct: 0, streak: 0 };

    function newIntervalQ() {
      var diff = document.getElementById('intDifficulty').value;
      var pool = INTERVALS[diff];
      var interval = pool[Math.floor(Math.random() * pool.length)];
      var baseMidi = 55 + Math.floor(Math.random() * 15);
      var direction = Math.random() > 0.3 ? 1 : -1;
      currentInterval = { name: interval.name, semi: interval.semi, hint: interval.hint, baseMidi: baseMidi, targetMidi: baseMidi + interval.semi * direction, dir: direction };
      document.getElementById('intNotes').textContent = '? ‚Üí ?';
      document.getElementById('intResult').className = 'match-result';
      document.getElementById('intResult').style.display = 'none';
      document.getElementById('nextIntBtn').style.display = 'none';

      var opts = document.getElementById('intOpts');
      opts.innerHTML = '';
      var options = new Set(); options.add(interval.name);
      var allNames = pool.map(function(i) { return i.name; });
      while (options.size < Math.min(4, pool.length)) {
        options.add(allNames[Math.floor(Math.random() * allNames.length)]);
      }
      var shuffled = Array.from(options).sort(function() { return Math.random() - 0.5; });
      shuffled.forEach(function(name) {
        var btn = document.createElement('button');
        btn.className = 'quiz-opt';
        btn.textContent = name;
        btn.onclick = function() { answerInterval(name, btn); };
        opts.appendChild(btn);
      });
    }

    function playIntervalQ(which) {
      if (!currentInterval) return;
      var f1 = midiToFreq(currentInterval.baseMidi);
      var f2 = midiToFreq(currentInterval.targetMidi);
      if (which === 'first') playTone(f1, 1.2);
      else if (which === 'second') playTone(f2, 1.2);
      else { playTone(f1, 1); setTimeout(function() { playTone(f2, 1.2); }, 1100); }
    }

    function answerInterval(name, btn) {
      var correct = currentInterval.name;
      document.querySelectorAll('#intOpts .quiz-opt').forEach(function(b) { b.classList.add('disabled'); });
      var res = document.getElementById('intResult');
      if (name === correct) {
        btn.classList.add('correct');
        intScore.correct++; intScore.streak++;
        var hint = currentInterval.hint ? ' Think: "' + currentInterval.hint + '"' : '';
        res.className = 'match-result show great';
        res.textContent = '‚úì Correct! ' + correct + ' (' + currentInterval.semi + ' semitones).' + hint;
      } else {
        btn.classList.add('wrong');
        intScore.streak = 0;
        document.querySelectorAll('#intOpts .quiz-opt').forEach(function(b) { if (b.textContent === correct) b.classList.add('correct'); });
        res.className = 'match-result show off';
        res.textContent = '‚úó That was a ' + correct + ' (' + currentInterval.semi + ' semitones).';
      }
      document.getElementById('intNotes').textContent = midiToName(currentInterval.baseMidi) + ' ‚Üí ' + midiToName(currentInterval.targetMidi);
      document.getElementById('intCorrect').textContent = intScore.correct;
      document.getElementById('intStreak').textContent = intScore.streak;
      document.getElementById('nextIntBtn').style.display = 'block';
    }

    // Init
    nextMatchNote();
    newIntervalQ();
  </script>

  <footer style="background:rgba(0,0,0,0.4);border-top:1px solid rgba(255,255,255,0.1);padding:2rem 1rem;text-align:center;font-family:system-ui,sans-serif;margin-top:2rem;">
    <p style="color:rgba(255,255,255,0.5);font-size:0.85rem;margin:0 0 0.5rem;">&#127925; VoiceStry &mdash; Vocal Training Reimagined</p>
    <p style="color:rgba(255,255,255,0.35);font-size:0.75rem;margin:0 0 0.75rem;">&copy; 2026 VoiceStry. Part of the <a href="https://aiunites.github.io/aiunites-site/" style="color:#a78bfa;">AIUNITES</a> network</p>
    <div style="max-width:680px;margin:0 auto;padding:1rem 1.5rem;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:0.8rem;line-height:1.5;color:rgba(255,255,255,0.7);">
      <strong style="color:#f87171;">&#9888;&#65039; Voice Health Disclaimer:</strong> VoiceStry is an educational tool and is not a substitute for professional vocal instruction or medical advice. Stop immediately if you experience pain, strain, hoarseness, or discomfort while singing. Consult a vocal coach or ENT specialist before beginning any intensive vocal training program. VoiceStry and AIUNITES are not responsible for vocal injury resulting from misuse of exercises or tools on this site.
    </div>
    <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid rgba(255,255,255,0.1);font-size:0.75rem;color:rgba(255,255,255,0.4);text-align:center;">
      <a href="https://aiunites.github.io/aiunites-site/legal.html#privacy" style="color:rgba(255,255,255,0.4);margin:0 8px;">Privacy Policy</a> &middot;
      <a href="https://aiunites.github.io/aiunites-site/legal.html#terms" style="color:rgba(255,255,255,0.4);margin:0 8px;">Terms of Service</a> &middot;
      <a href="https://github.com/AIUNITES/voicestry-site/issues" target="_blank" style="color:rgba(255,255,255,0.4);margin:0 8px;">Developer Feedback</a>
    </div>
  </footer>

</body>
</html>